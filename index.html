<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zyada – Live MVP (Enhanced Customer Map)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<meta name="description" content="Zyada (زيادة) live MVP connected to Google Sheets via Apps Script with Leaflet map, filters, and auto-location.">
<style>
  :root{ --emerald:#22c55e; --emerald-600:#16a34a; --coral:#f97316; --amber:#f59e0b;
    --bg1:#ecfdf5; --bg2:#fff; --bg3:#fffbeb; --text:#0f172a; --muted:#64748b;
    --ring: 0 0 0 3px rgba(34,197,94,.25); --card:#ffffffcc; --border:#e2e8f0; }
  *{box-sizing:border-box} img{max-width:100%;height:auto;display:block}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,'Tajawal';line-height:1.5;color:var(--text);
       background: radial-gradient(1200px 800px at 10% -10%, var(--bg1), transparent),
                   radial-gradient(1000px 800px at 110% -10%, var(--bg3), transparent), var(--bg2);}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .header{position:sticky;top:0;z-index:30;backdrop-filter:saturate(140%) blur(8px);background:#ffffffb3;border-bottom:1px solid var(--border)}
  .header .row{display:flex;justify-content:space-between;align-items:center;padding:10px 16px}
  .logo{display:flex;align-items:center;gap:10px;font-weight:900;font-size:20px}
  .badge{background:#dcfce7;color:#065f46;border:1px solid #bbf7d0;padding:4px 8px;border-radius:999px;font-size:12px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid var(--border);
       background:white;cursor:pointer;font-weight:800}
  .btn.primary{background:var(--emerald);border-color:var(--emerald);color:white;box-shadow:0 10px 24px rgba(34,197,94,.25)}
  .btn.primary:hover{background:var(--emerald-600)}
  .btn:focus{outline:none;box-shadow:var(--ring)}
  .btn.lg{padding:14px 18px;border-radius:16px}
  .tabs{display:flex;gap:8px;margin:16px 0;overflow:auto}
  .tab{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:white;font-weight:800;cursor:pointer;flex:0 0 auto}
  .tab.active{background:var(--emerald);border-color:var(--emerald);color:#fff}
  .grid{display:grid;gap:16px}
  @media(min-width:960px){.grid.two{grid-template-columns:1.2fr .8fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.04)}
  .p-16{padding:16px}.p-20{padding:20px}.p-24{padding:24px}
  h1{font-size:40px;line-height:1.2;margin:0 0 8px} @media(max-width:600px){ h1{font-size:30px} }
  .lead{color:var(--muted);font-size:18px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}.chip{background:#f1f5f9;border:1px solid var(--border);padding:8px 12px;border-radius:999px;font-size:13px;font-weight:700;cursor:pointer}
  .chip.on{background:#dcfce7;border-color:#bbf7d0;color:#065f46}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
  .kpi{background:white;border:1px solid var(--border);border-radius:14px;padding:14px;text-align:center}
  .kpi .n{font-size:22px;font-weight:900}
  .mock{position:relative;min-height:320px;background:linear-gradient(45deg,#f0fdf4,white);border-radius:16px;overflow:hidden;border:1px solid var(--border)}
  .offers{display:grid;gap:10px;max-height:520px;overflow:auto}
  .offer{display:grid;grid-template-columns:92px 1fr auto;gap:12px;background:white;border:1px solid var(--border);border-radius:14px;padding:10px}
  @media(max-width:520px){ .offer{grid-template-columns:80px 1fr; } .offer .reserve{grid-column:1/-1} }
  .offer .thumb{width:92px;height:92px;border-radius:12px;background-size:cover;background-position:center;border:1px solid var(--border)}
  .offer .name{font-weight:900}.offer .meta{font-size:12px;color:#64748b}
  .price{display:flex;align-items:center;gap:8px;margin-top:4px}
  .now{color:#047857;font-weight:900}.was{text-decoration:line-through;color:#9ca3af;font-size:12px}
  .filters{display:flex;flex-wrap:wrap;gap:10px}
  .input,.select{padding:12px;border-radius:14px;border:1px solid var(--border);background:white;font-size:16px}
  .range{accent-color:var(--emerald)}
  .map{height:520px;border:1px solid var(--border);border-radius:16px;overflow:hidden;position:relative}
  #map{height:100%;width:100%}
  .map-tools{position:absolute;top:10px;right:10px;display:flex;gap:8px;z-index:10}
  .loading{padding:14px;text-align:center;color:#64748b}
  .empty{padding:14px;text-align:center;color:#64748b}
  .footer{color:#64748b;padding:72px 16px 24px}
  .logo-mark{width:32px;height:32px}
  .row-gap{display:flex;gap:12px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#fff7ed;border:1px solid #fde68a;color:#92400e;padding:8px 12px;border-radius:999px;font-size:12px;font-weight:800}
  .impact{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
  .impact .stat{background:linear-gradient(135deg,#ffffff,#f8fafc);border:1px solid var(--border);border-radius:14px;padding:14px}
  .impact .big{font-size:26px;font-weight:900;color:#065f46}
  .impact .small{font-size:12px;color:#64748b}
  .trust{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media(max-width:920px){.impact,.trust{grid-template-columns:1fr}}
  .trust .tcard{background:white;border:1px solid var(--border);border-radius:14px;padding:14px}
  .tcard h3{margin:0 0 6px;font-size:18px}
  .tick{color:#16a34a;font-weight:900}
  .note{font-size:12px;color:#64748b}
  .bbar{position:fixed;bottom:0;left:0;right:0;z-index:40;background:#ffffffee;border-top:1px solid var(--border);backdrop-filter:blur(6px);display:none}
  .bbar .row{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;gap:10px}
  .bbar .btn{flex:1}
  @media(max-width:860px){ .bbar{display:block} }
</style>
</head>
<body>
  <header class="header">
    <div class="row wrap">
      <div class="logo">
        <svg class="logo-mark" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop offset="0" stop-color="#22c55e"/><stop offset="1" stop-color="#16a34a"/></linearGradient></defs><circle cx="36" cy="36" r="30" fill="url(#g)"/><path d="M48 26 a8 8 0 1 1 -2 2" fill="#fff7ed"/><path d="M24 44 C 32 54, 44 54, 52 44" fill="none" stroke="#f97316" stroke-width="6" stroke-linecap="round"/></svg>
        <div><span id="brand">Zyada</span> <span style="color:#f59e0b">زيادة</span></div>
        <span class="badge" id="betaLabel">UAE • Beta</span>
      </div>
      <div class="row-gap">
        <button class="btn" data-tabto="customers" id="ctaFind">Find deals</button>
        <button class="btn primary" data-tabto="partners" id="ctaPartner">For restaurants</button>
        <button class="btn" id="langToggle" aria-label="Toggle language">العربية</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="tabs">
      <button class="tab active" data-tab="home" id="tabHome">Home</button>
      <button class="tab" data-tab="customers" id="tabCustomers">Customers</button>
      <button class="tab" data-tab="partners" id="tabPartners">Restaurants</button>
    </div>

    <section id="home" class="grid two">
      <div class="card p-20">
        <div class="pill" id="pillFresh">Fresh food, extra savings</div>
        <h1 id="homeHeadline">Rescue tasty <span class="chip on">surplus</span> food near you</h1>
        <p class="lead" id="homeLead">Zyada (زيادة) connects you to end‑of‑day <b>fresh surplus</b> made the same day — safely packed and discounted. Save money, reduce waste, feel good.</p>
      </div>

      <div class="card p-0">
        <div class="mock">
          <div style="position:absolute;inset:0;padding:16px">
            <div class="offers" style="grid-template-columns:repeat(2,1fr)">
              <div class="offer"><div class="thumb" style="background-image:url('https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?q=80&w=600&auto=format&fit=crop')"></div><div><div class="name">Pastry Box</div><div class="meta">Local Café • Bakery</div><div class="price"><span class="now">AED 12</span><span class="was">AED 30</span><span class="chip on">60% off</span></div></div><button class="btn primary reserve">Reserve</button></div>
              <div class="offer"><div class="thumb" style="background-image:url('https://images.unsplash.com/photo-1604908553613-69474a4db1df?q=80&w=600&auto=format&fit=crop')"></div><div><div class="name">Chicken Biryani</div><div class="meta">Karachi Kitchen • Pakistani</div><div class="price"><span class="now">AED 15</span><span class="was">AED 28</span><span class="chip on">46% off</span></div></div><button class="btn primary reserve">Reserve</button></div>
              <div class="offer"><div class="thumb" style="background-image:url('https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=600&auto=format&fit=crop')"></div><div><div class="name">Sushi Surprise (6pc)</div><div class="meta">Umi Sushi • Japanese</div><div class="price"><span class="now">AED 24</span><span class="was">AED 48</span><span class="chip on">50% off</span></div></div><button class="btn primary reserve">Reserve</button></div>
              <div class="offer"><div class="thumb" style="background-image:url('https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=600&auto=format&fit=crop')"></div><div><div class="name">Grill Box</div><div class="meta">Kebabish • Middle Eastern</div><div class="price"><span class="now">AED 25</span><span class="was">AED 45</span><span class="chip on">44% off</span></div></div><button class="btn primary reserve">Reserve</button></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="customers" class="grid two" style="display:none">
      <div class="card p-16">
        <div class="filters">
          <input class="input" id="q" placeholder="Search item or restaurant…">
          <button class="btn lg" id="openFilters">Filters</button>
          <button class="btn lg" id="useLocation">Use my location</button>
          <button class="btn lg" id="recenter" style="display:none">Recenter</button>
          <button class="chip" id="fHalal">Halal</button>
          <button class="chip" id="fVeg">Veg</button>
        </div>
        <div class="map" style="margin-top:10px">
          <div id="map" aria-label="Map of nearby offers"></div>
          <div class="map-tools">
            <div class="btn" id="sortByNearest" title="Sort by nearest">Nearest</div>
          </div>
        </div>
      </div>
      <div id="listWrap" class="card p-16">
        <div id="listStatus" class="loading">Loading offers…</div>
        <div class="offers" id="offersList" style="display:none"></div>
      </div>
    </section>

    <section id="partners" style="display:none" class="grid two">
      <div class="card p-24">
        <h2 style="margin:0 0 8px;font-size:30px" id="partnerHeadline">List your daily surplus in minutes</h2>
        <p class="lead" id="partnerLead">Turn end‑of‑day surplus into new customers and extra revenue. No monthly fees during beta. Post items, set pickup window & discount, go live.</p>
        <div class="row-gap" style="margin-top:10px">
          <button class="btn primary lg" id="contactUs">Contact us</button>
        </div>
        <div class="steps" style="margin-top:14px">
          <div class="step"><div class="bullet">1</div><div><div class="name" style="font-weight:900" id="s1Title">Submit outlet details</div><div class="meta" id="s1Text">We add you to the map with your logo & address</div></div></div>
          <div class="step"><div class="bullet">2</div><div><div class="name" style="font-weight:900" id="s2Title">Post today’s surplus</div><div class="meta" id="s2Text">Name, price before/after, halal/veg, quantity, pickup times</div></div></div>
          <div class="step"><div class="bullet">3</div><div><div class="name" style="font-weight:900" id="s3Title">Customers reserve & pick up</div><div class="meta" id="s3Text">Show code at pickup and pay on site (beta)</div></div></div>
        </div>
      </div>
    </section>
  </main>

  <div class="bbar">
    <div class="row">
      <button class="btn" data-tabto="customers" id="bbarFind">Find deals</button>
      <button class="btn primary" data-tabto="partners" id="bbarPartner">For restaurants</button>
    </div>
  </div>

  <footer class="wrap footer">© <span id="yr"></span> Zyada • Live MVP</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwLb9oF5dImxEh2XvLLUC8uqAbiLNj8WmfZWyp4ogdSxyuaAycpei7OW5i_VaXC0pM2OQ/exec";

document.getElementById('yr').textContent = new Date().getFullYear();
let currentLang='en';
document.getElementById('langToggle').addEventListener('click', ()=>{
  currentLang = (currentLang==='en'?'ar':'en');
  const html = document.documentElement;
  html.lang = (currentLang==='ar' ? 'ar' : 'en');
  html.dir = (currentLang==='ar' ? 'rtl' : 'ltr');
  document.getElementById('langToggle').textContent = (currentLang==='ar' ? 'English' : 'العربية');
});

const tabs = document.querySelectorAll('.tab');
const sections = ['home','customers','partners'].map(id => document.getElementById(id));
tabs.forEach(btn => btn.addEventListener('click', () => {
  tabs.forEach(b=>b.classList.remove('active')); btn.classList.add('active');
  const id = btn.dataset.tab; sections.forEach(s => s.style.display = (s.id===id ? '' : 'none')); window.scrollTo({top:0,behavior:'smooth'});
  if(id==='customers' && !window._mapReady) initMapAndData(true);
}));
document.querySelectorAll('[data-tabto]').forEach(el => el.addEventListener('click', () => {
  const id = el.getAttribute('data-tabto'); document.querySelector(`.tab[data-tab="${id}"]`).click();
}));

const drawerBtn = document.getElementById('openFilters');
drawerBtn.addEventListener('click', ()=>alert('Filter drawer coming soon (max price, halal/veg). Use quick chips for now.'));

let map, markers, userMarker;
let OFFERS = [];
let filters = { q:'', halal:false, veg:false };
let userPos = null;

document.getElementById('q').addEventListener('input', (e)=>{ filters.q = e.target.value.toLowerCase(); render(); });
document.getElementById('fHalal').addEventListener('click', ()=>{ filters.halal=!filters.halal; toggleChip('fHalal',filters.halal); render(); });
document.getElementById('fVeg').addEventListener('click', ()=>{ filters.veg=!filters.veg; toggleChip('fVeg',filters.veg); render(); });
function toggleChip(id,on){ const el=document.getElementById(id); el.classList.toggle('on', on); }

document.getElementById('useLocation').addEventListener('click', ()=> locate(true));
document.getElementById('recenter').addEventListener('click', ()=>{ if(userPos) map.setView(userPos, 13); });

document.getElementById('sortByNearest').addEventListener('click', ()=>{
  if(!userPos){ alert('Enable location first to sort by nearest.'); return; }
  OFFERS.sort((a,b)=> (a._dist??1e9) - (b._dist??1e9));
  render(true);
});

function initMapAndData(autoLocate){
  if(window._mapReady) return;
  window._mapReady = true;
  map = L.map('map').setView([25.2048, 55.2708], 11); // Dubai
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
  markers = L.layerGroup().addTo(map);

  fetchOffers();
  if(autoLocate) locate(false);
}

async function fetchOffers(){
  const status = document.getElementById('listStatus');
  const list = document.getElementById('offersList');
  status.style.display = 'block'; list.style.display = 'none'; status.textContent = 'Loading offers…';
  try{
    const res = await fetch(API_URL, { cache: 'no-store' });
    const data = await res.json();
    OFFERS = data.map(x=>({
      PartnerName: x.PartnerName || '',
      OutletName: x.OutletName || '',
      ItemName: x.ItemName || '',
      Cuisine: x.Cuisine || '',
      PriceBefore: parseFloat(x.PriceBefore || 0),
      PriceAfter: parseFloat(x.PriceAfter || 0),
      Halal: (''+(x.Halal||'')).toLowerCase().startsWith('y'),
      Veg: (''+(x.Veg||'')).toLowerCase().startsWith('y'),
      Qty: parseInt(x.Qty || 0),
      PickupStart: x.PickupStart || '',
      PickupEnd: x.PickupEnd || '',
      Address: x.Address || '',
      Lat: parseFloat(x.Lat || NaN),
      Lng: parseFloat(x.Lng || NaN),
      ImageUrl: x.ImageUrl || ''
    }));
    status.style.display = 'none'; list.style.display = 'grid';
    render(true);
  }catch(err){
    console.error(err);
    status.textContent = 'Could not load offers. Check your Apps Script is public (Anyone can access).';
  }
}

function locate(center){
  if(!navigator.geolocation) return alert('Geolocation not supported');
  navigator.geolocation.getCurrentPosition(pos=>{
    userPos = [pos.coords.latitude, pos.coords.longitude];
    if(center) map.setView(userPos, 13);
    drawUserMarker();
    OFFERS.forEach(o=>{ if(!isNaN(o.Lat)&&!isNaN(o.Lng)) o._dist = haversine(userPos, [o.Lat,o.Lng]); });
    render(true);
    document.getElementById('recenter').style.display = 'inline-flex';
  }, err=>{
    console.warn(err); alert('Location permission denied.');
  });
}

function drawUserMarker(){
  if(!map || !userPos) return;
  if(userMarker) map.removeLayer(userMarker);
  userMarker = L.circleMarker(userPos, { radius:8, color:'#2563eb', fillColor:'#3b82f6', fillOpacity:0.8 }).addTo(map).bindPopup('You are here');
}

function matches(o){
  if(filters.halal && !o.Halal) return false;
  if(filters.veg && !o.Veg) return false;
  const q=filters.q;
  if(q){
    const hay = (o.ItemName+' '+o.PartnerName+' '+o.OutletName+' '+o.Cuisine).toLowerCase();
    if(!hay.includes(q)) return false;
  }
  return true;
}

function render(fitBounds){
  if(!markers) return;
  const list = document.getElementById('offersList');
  markers.clearLayers();
  list.innerHTML = '';

  if(userPos) OFFERS.forEach(o=>{ if(!isNaN(o.Lat)&&!isNaN(o.Lng)) o._dist = haversine(userPos, [o.Lat,o.Lng]); });

  const filtered = OFFERS.filter(matches);
  if(filtered.length===0){ document.getElementById('listStatus').style.display='block'; document.getElementById('listStatus').textContent='No offers match yet — try clearing filters.'; list.style.display='none'; return; }
  document.getElementById('listStatus').style.display='none'; list.style.display='grid';

  filtered.sort((a,b)=>{
    if(userPos) return (a._dist??1e9) - (b._dist??1e9);
    const da = discountPct(a), db = discountPct(b);
    return db - da;
  });

  const bounds = [];
  filtered.forEach(o=>{
    const img = o.ImageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?q=80&w=600&auto=format&fit=crop';
    const distText = (userPos && isFinite(o._dist)) ? ` • ${formatKm(o._dist)}` : '';
    const card = document.createElement('div'); card.className='offer';
    card.innerHTML = `
      <div class="thumb" style="background-image:url('${img}')"></div>
      <div>
        <div class="name">${escapeHtml(o.ItemName)} <span class="chip on">${discountPct(o)}% off</span></div>
        <div class="meta">${escapeHtml(o.PartnerName)} • ${escapeHtml(o.Cuisine||'')} ${o.Halal?'• Halal':''} ${o.Veg?'• Veg':''}${distText}</div>
        <div class="price"><span class="now">AED ${fmt(o.PriceAfter)}</span> ${o.PriceBefore?`<span class="was">AED ${fmt(o.PriceBefore)}</span>`:''} <span class="chip">Pickup ${escapeHtml(o.PickupStart||'')}–${escapeHtml(o.PickupEnd||'')}</span></div>
        <div class="row-gap" style="margin-top:6px">
          ${(o.Lat&&!isNaN(o.Lat)&&o.Lng&&!isNaN(o.Lng))?`<a class="btn" href="https://www.google.com/maps?q=${o.Lat},${o.Lng}" target="_blank" rel="noopener">Open in Maps</a>`:''}
          <button class="btn primary">Reserve</button>
        </div>
      </div>`;
    list.appendChild(card);

    if(!isNaN(o.Lat) && !isNaN(o.Lng)){
      const popup = `
        <div style="width:220px">
          <img src="${img}" alt="" style="width:100%;height:110px;object-fit:cover;border-radius:10px;margin-bottom:6px">
          <b>${escapeHtml(o.ItemName)}</b><br/>
          AED ${fmt(o.PriceAfter)} ${o.PriceBefore?`<span class="was" style="text-decoration:line-through;color:#9ca3af">AED ${fmt(o.PriceBefore)}</span>`:''}<br/>
          <small>${escapeHtml(o.PartnerName)} • ${escapeHtml(o.Cuisine||'')}${distText?` • ${formatKm(o._dist)}`:''}</small><br/>
          <small>Pickup ${escapeHtml(o.PickupStart||'')}–${escapeHtml(o.PickupEnd||'')}</small><br/>
          <a href="https://www.google.com/maps?q=${o.Lat},${o.Lng}" target="_blank" rel="noopener">Open in Google Maps</a>
        </div>`;
      const m = L.marker([o.Lat,o.Lng]).addTo(markers).bindPopup(popup);
      bounds.push([o.Lat,o.Lng]);
    }
  });

  if(fitBounds && bounds.length) map.fitBounds(bounds, { padding:[30,30] });
  drawUserMarker();
}

function discountPct(o){
  const b = o.PriceBefore||0, a = o.PriceAfter||0;
  if(!b||!a||a>=b) return 0;
  return Math.round((1 - (a/b)) * 100);
}

function fmt(n){ return (Math.round((n||0)*100)/100).toLocaleString(); }
function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

function haversine(a, b){
  const toRad = d => d*Math.PI/180;
  const R = 6371; // km
  const dLat = toRad(b[0]-a[0]);
  const dLon = toRad(b[1]-a[1]);
  const lat1 = toRad(a[0]);
  const lat2 = toRad(b[0]);
  const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}
function formatKm(km){
  if(km < 1) return Math.round(km*1000)+' m';
  return km.toFixed(1)+' km';
}

if(location.hash==="#customers"){ document.querySelector('.tab[data-tab="customers"]').click(); }
</script>
</body>
</html>
