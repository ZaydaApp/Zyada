<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zyada - Fresh Surplus, Happy Savings</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    header { background: #4caf50; padding: 1em; text-align:center; color:white; font-size:1.5em; }
    .offers { display:flex; flex-wrap:wrap; gap:1em; padding:1em; }
    .offer { border:1px solid #ddd; border-radius:8px; overflow:hidden; width:300px; }
    .offer img { width:100%; height:200px; object-fit:cover; }
    .offer-details { padding:0.5em; }
    .offer-details h3 { margin:0; font-size:1.2em; }
    .reserve-btn { display:inline-block; padding:0.5em 1em; background:#4caf50; color:white; border:none; cursor:pointer; border-radius:4px; }
    #map { height:400px; }
  </style>
</head>
<body>
<header>Zyada - Fresh Surplus, Happy Savings</header>

<section id="map"></section>
<section class="offers" id="offers"></section>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxLP7HKN-O-_lzvNxu4SQymvqI2_ofJuOdS_RZ85ijUJgT-QManwCpIGKxm9pTxdkuQmA/exec";

async function fetchOffers() {
  const res = await fetch(API_URL + "?route=offers");
  const data = await res.json();
  renderOffers(data);
  renderMap(data);
}

function renderOffers(offers) {
  const container = document.getElementById('offers');
  container.innerHTML = '';
  offers.forEach(o => {
    const card = document.createElement('div');
    card.className = 'offer';
    card.innerHTML = `
      <img src="${o.ImageUrl}" alt="${o.ItemName}" />
      <div class="offer-details">
        <h3>${o.ItemName}</h3>
        <p>${o.OutletName}</p>
        <p><del>AED ${o.PriceBefore}</del> <strong>AED ${o.PriceAfter}</strong></p>
        <p>Pickup: ${o.PickupStart} - ${o.PickupEnd}</p>
        <button class="reserve-btn" onclick="reserveOffer('${o.OfferId}')">Reserve</button>
      </div>
    `;
    container.appendChild(card);
  });
}

function renderMap(offers) {
  const map = L.map('map').setView([25.276987, 55.296249], 11); // Default Dubai
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
  }).addTo(map);
  offers.forEach(o => {
    if(o.Lat && o.Lng) {
      L.marker([o.Lat, o.Lng])
        .addTo(map)
        .bindPopup(`<b>${o.ItemName}</b><br>${o.OutletName}<br><strong>AED ${o.PriceAfter}</strong>`);
    }
  });
}

async function reserveOffer(offerId) {
  const customerName = prompt('Enter your name:');
  if(!customerName) return;
  const customerPhone = prompt('Enter your phone number:');
  const res = await fetch(API_URL + "?route=reserve", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ offerId, customerName, customerPhone })
  });
  const data = await res.json();
  if(data.ok) {
    alert(`Reserved! Pickup Code: ${data.PickupCode}\nExpires At: ${data.ExpiresAt}`);
  } else {
    alert('Reservation failed: ' + (data.reason || 'Unknown error'));
  }
}

fetchOffers();
</script>
</body>
</html>
