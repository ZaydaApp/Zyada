<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Zyada — Surplus near you</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  :root{ --brand:#22c55e; --ink:#0f172a; --muted:#64748b; --bg:#f8fafc; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; color:var(--ink); background:var(--bg);}
  header{ position:sticky; top:0; z-index:20; background:#fff; border-bottom:1px solid #e5e7eb; padding:12px 16px; display:flex; align-items:center; gap:12px;}
  .logo{ font-weight:800; font-size:20px; color:var(--ink);}
  .logo b{ color:var(--brand)}
  main{ display:grid; grid-template-columns: 1fr 420px; gap:16px; padding:16px; }
  #map{ height: calc(100vh - 88px); border-radius:12px; border:1px solid #e5e7eb; }
  .panel{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; }
  .panel h2{ margin:0; padding:12px 16px; border-bottom:1px solid #e5e7eb; font-size:16px;}
  .list{ padding:12px; overflow:auto; }
  .offer{ border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; margin-bottom:12px; display:grid; grid-template-columns:96px 1fr; }
  .offer img{ width:96px; height:96px; object-fit:cover; }
  .offer .info{ padding:10px; display:grid; gap:4px; }
  .meta{ font-size:12px; color:var(--muted); }
  .prices{ display:flex; align-items:center; gap:8px; }
  .old{ text-decoration:line-through; color:#94a3b8; }
  .qtybadge{ font-size:12px; padding:2px 8px; border-radius:999px; background:#f1f5f9; }
  .btn{ appearance:none; border:none; background:var(--brand); color:white; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
  .btn[disabled]{ opacity:.5; cursor:not-allowed; }
  @media (max-width:900px){ main{ grid-template-columns:1fr; } #map{ height:320px; } }
</style>
</head>
<body>
<header>
  <div class="logo">Z<b>yada</b></div>
  <div style="margin-left:auto; color:var(--muted); font-size:14px" id="stats">—</div>
</header>

<main>
  <div id="map"></div>
  <div class="panel">
    <h2>Today’s surplus</h2>
    <div class="list" id="offersList"></div>
  </div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzCbrmNhKBolTojPlml2_dTUAWb2F9UiI3jG8lAEzrasEPe7s0mUgxePNcRL3xCcxU-lw/exec';

(function(){
  const url = API_URL + '?route=offers_js&cb=initOffers&_ts=' + Date.now();
  const s = document.createElement('script');
  s.src = url;
  s.onerror = function(){
    document.getElementById('zyada-debug').textContent =
      'JSONP load error.\nTried: ' + url + '\nCheck API_URL and that /dev returns offers_js.';
  };
  document.body.appendChild(s);
})();


function $(q){ return document.querySelector(q); }
function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
function fmt(n){ return (Number(n)||0).toFixed(2); }

// Debug box
const dbg = document.createElement('pre');
dbg.id = 'zyada-debug';
dbg.style.cssText = 'white-space:pre-wrap;font-size:12px;background:#fff;border:1px solid #e5e7eb;padding:8px;margin:8px 16px;border-radius:8px;';
dbg.textContent = 'Debug: loading offers…';
document.body.appendChild(dbg);

// Map
const map = L.map('map').setView([25.20, 55.27], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
const markers = L.layerGroup().addTo(map);

let OFFERS = [];

function render(){
  markers.clearLayers();
  const list = document.getElementById('offersList'); list.innerHTML='';
  const bounds = [];
  if (!Array.isArray(OFFERS) || !OFFERS.length){
    list.innerHTML = '<div class="meta">No offers yet.</div>';
    return;
  }
  OFFERS.forEach(o=>{
    const qty = Number(o.Qty||0), sold = qty<=0;
    const img = o.ImageUrl || 'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?q=80&w=600&auto=format&fit=crop';
    const div = document.createElement('div');
    div.className='offer';
    div.innerHTML = `
      <img src="${esc(img)}" alt="">
      <div class="info">
        <div><strong>${esc(o.ItemName||'')}</strong></div>
        <div class="meta">${esc(o.PartnerName||o.OutletName||'')} • ${esc(o.Cuisine||'')}</div>
        <div class="prices">
          <div><strong>AED ${fmt(o.PriceAfter)}</strong></div>
          ${o.PriceBefore? `<div class="old">AED ${fmt(o.PriceBefore)}</div>`:''}
          <div class="qtybadge">${sold?'Sold out':'Qty '+qty}</div>
        </div>
        <div class="meta">Pickup ${esc(o.PickupStart||'')}–${esc(o.PickupEnd||'')}</div>
        <div><button class="btn" ${sold?'disabled':''} onclick="beginCheckout('${esc(o.OfferId||'')}')">Pay & Reserve</button></div>
      </div>`;
    list.appendChild(div);
    if (!isNaN(Number(o.Lat)) && !isNaN(Number(o.Lng))) {
      const m = L.marker([Number(o.Lat), Number(o.Lng)]).addTo(markers);
      m.bindPopup(`<b>${esc(o.ItemName||'')}</b><br>AED ${fmt(o.PriceAfter||0)}<br>${sold?'Sold out':'Available'}`);
      bounds.push([Number(o.Lat), Number(o.Lng)]);
    }
  });
  if (bounds.length) map.fitBounds(bounds, { padding:[30,30] });
}

// JSONP callback
function initOffers(data){
  OFFERS = Array.isArray(data) ? data : [];
  dbg.textContent = 'Offers loaded: ' + OFFERS.length;
  render();
}

// Load via JSONP with cache‑buster and error trap
(function(){
  const url = API_URL + '?route=offers_js&cb=initOffers&_ts=' + Date.now();
  const s = document.createElement('script');
  s.src = url;
  s.onerror = function(){
    dbg.textContent = 'JSONP load error.\nTried: ' + url + '\nCheck API_URL and that /dev returns offers_js.';
  };
  document.body.appendChild(s);
})();

// Begin checkout (redirect to Apps Script begin)
function beginCheckout(offerId){
  const name  = prompt('Your name (for pickup):','') || '';
  if (!name.trim()) return;
  const phone = prompt('Mobile (optional):','') || '';
  const url = API_URL + '?route=begin&offerId=' + encodeURIComponent(offerId) +
              '&name=' + encodeURIComponent(name.trim()) +
              '&phone=' + encodeURIComponent(phone.trim());
  location.href = url;
}
</script>

</body>
</html>
