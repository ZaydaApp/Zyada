<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zyada â€” Fresh Surplus, Happy Savings</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --emerald:#22c55e; --border:#e2e8f0; --muted:#64748b; --ink:#0f172a; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Arial;color:var(--ink)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .brand{font-weight:900;font-size:18px;display:flex;gap:10px;align-items:center}
    .btn{border:1px solid var(--border);padding:10px 14px;border-radius:12px;background:#fff;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--emerald);border-color:var(--emerald);color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px} @media(min-width:960px){.two{grid-template-columns:1.1fr .9fr}}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .input{padding:12px;border-radius:12px;border:1px solid var(--border)}
    .offers{display:grid;gap:10px;max-height:520px;overflow:auto}
    .offer{display:grid;grid-template-columns:92px 1fr auto;gap:12px;border:1px solid var(--border);border-radius:14px;padding:10px;position:relative}
    .thumb{width:92px;height:92px;border-radius:12px;background-size:cover;background-position:center;border:1px solid var(--border)}
    .meta{color:var(--muted);font-size:12px}
    .price{display:flex;gap:8px;align-items:center;margin-top:4px}
    .now{color:#047857;font-weight:900}
    .was{text-decoration:line-through;color:#94a3b8;font-size:12px}
    .qtybadge{position:absolute;top:8px;right:8px;background:#111827;color:#fff;font-size:11px;padding:4px 8px;border-radius:999px}
    .soldout{background:#ef4444!important}
    .map{height:520px;border:1px solid var(--border);border-radius:16px;overflow:hidden;position:relative}
    #map{height:100%}
    @media(max-width:560px){.offer{grid-template-columns:80px 1fr}.offer .reserve{grid-column:1/-1}}
    .note{font-size:12px;color:var(--muted)}
    /* Impact stats */
    .stats{display:grid;gap:12px;grid-template-columns:1fr;margin-bottom:12px}
    @media(min-width:720px){.stats{grid-template-columns:repeat(3,1fr)}}
    .stat{border:1px solid var(--border);border-radius:16px;padding:16px;background:#fff;display:flex;align-items:center;gap:12px}
    .stat .icon{font-size:22px}.stat .val{font-size:22px;font-weight:900}.stat .lbl{color:var(--muted);font-size:12px}
    /* Keep Leaflet below overlays */
    .leaflet-container,.leaflet-pane,.leaflet-top,.leaflet-bottom{z-index:0!important}
  </style>
</head>
<body>
  <header>
    <div class="brand">Zyada <span style="color:#16a34a">Ø²ÙŠØ§Ø¯Ø©</span></div>
    <div class="actions">
      <a class="btn" href="my.html">My reservation</a>
      <a class="btn" href="partner.html">Partner redeem</a>
      <button class="btn" id="ping">Ping API</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Impact stats -->
    <section class="stats">
      <div class="stat"><div class="icon">ðŸ¥—</div><div><div class="val" id="stMeals">0</div><div class="lbl">Meals rescued</div></div></div>
      <div class="stat"><div class="icon">ðŸŒ±</div><div><div class="val" id="stCO2">0</div><div class="lbl">COâ‚‚ saved (kg)</div></div></div>
      <div class="stat"><div class="icon">ðŸ’°</div><div><div class="val" id="stAED">0</div><div class="lbl">AED saved</div></div></div>
    </section>

    <section class="grid two">
      <section class="card">
        <div class="filters">
          <input id="q" class="input" placeholder="Search item or restaurantâ€¦" />
          <button id="useLocation" class="btn">Use my location</button>
        </div>
        <div class="map" style="margin-top:10px"><div id="map" aria-label="Map of nearby offers"></div></div>
      </section>

      <aside>
        <div id="offersCount" class="note" style="margin:0 0 6px 0;"></div>
        <div class="offers" id="offersList"></div>
      </aside>
    </section>
  </main>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  (function(){
    const API_URL = "https://script.google.com/macros/s/AKfycbwEQp1C6ff3ll53F8sw2TpTw171jB_iL2YW7iI5LrOQragU21d1AZxogoSZ8NDfKIXSfw/exec";

    // helpers
    const $ = s => document.querySelector(s);
    const fmt = n => (Math.round(Number(n||0)*100)/100).toLocaleString();
    const esc = s => String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const timeLabel = (v)=>{
      if(!v) return '';
      const d = new Date(v); if(isNaN(d)) return String(v);
      return d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
    };

    // lazy expiry: run once on load, then every 5 min
    fetch(API_URL + '?route=expire', { cache: 'no-store' }).catch(()=>{});
    setInterval(()=>{ fetch(API_URL + '?route=expire', { cache:'no-store' }).catch(()=>{}); }, 5*60*1000);

    // ping
    $('#ping').addEventListener('click', async () => {
      try { const r = await fetch(API_URL + '?route=health', { cache:'no-store' }); alert(await r.text()); }
      catch { alert('API health failed'); }
    });

    // metrics
    async function fetchMetrics(){
      try{
        const r = await fetch(API_URL + '?route=metrics', { cache:'no-store' });
        const m = await r.json();
        $('#stMeals').textContent = (m.meals||0).toLocaleString();
        $('#stCO2').textContent   = (m.kgCO2e||0).toLocaleString();
        $('#stAED').textContent   = (m.aedSaved||0).toLocaleString();
      }catch{}
    }

    // map
    let map, markers;
    function initMap(){
      map = L.map('map').setView([25.276987,55.296249],11); // Dubai
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(map);
      markers = L.layerGroup().addTo(map);
    }

    // offers + render
    let OFFERS = []; let filters = { q:'' };

    async function fetchOffers(){
      try{
        const r = await fetch(API_URL + '?route=offers', { cache:'no-store' });
        const data = await r.json();
        console.log('OFFERS JSON:', data);
        OFFERS = Array.isArray(data) ? data : [];
        const count = $('#offersCount'); if (count) count.textContent = 'Loaded ' + OFFERS.length + ' offer(s)';
        render();
      }catch(e){
        console.error('Offers fetch failed:', e);
        $('#offersList').innerHTML = '<div class="note">Could not load offers.</div>';
      }
    }

    function matches(o){
      const q = (filters.q||'').toLowerCase();
      if (!q) return true;
      const hay = ((o.ItemName||'')+' '+(o.PartnerName||'')+' '+(o.OutletName||'')+' '+(o.Cuisine||'')).toLowerCase();
      return hay.includes(q);
    }

    function render(){
      if (markers && markers.clearLayers) markers.clearLayers();
      const list = $('#offersList'); list.innerHTML = '';
      const filtered = (OFFERS||[]).filter(matches);
      if (!filtered.length){ list.innerHTML = '<div class="note">No offers yet.</div>'; return; }

      const bounds = [];
      filtered.forEach(o=>{
        const img  = (o.ImageUrl||'').trim() || 'https://images.unsplash.com/photo-1546069901-eacef0df6022';
        const qty  = Number(o.Qty||0);
        const sold = qty <= 0;
        const offerId = o.OfferId || '';
        const pickup = (o.PickupStart && o.PickupEnd) ? `Pickup ${timeLabel(o.PickupStart)}â€“${timeLabel(o.PickupEnd)}` : '';

        // card
        const card = document.createElement('div'); card.className = 'offer'; card.dataset.offerId = offerId;
        card.innerHTML =
          '<div class="thumb" style="background-image:url(\''+img.replace(/'/g,"\\'")+'\')"></div>'+
          '<div>'+
            '<strong>'+esc(o.ItemName||'')+'</strong>'+
            '<div class="meta">'+esc(o.PartnerName||o.OutletName||'')+(o.Cuisine?(' â€¢ '+esc(o.Cuisine)):'')+'</div>'+
            '<div class="price"><span class="now">AED '+fmt(o.PriceAfter)+'</span>'+(o.PriceBefore?('<span class="was">AED '+fmt(o.PriceBefore)+'</span>'):'')+'</div>'+
            '<div class="meta">'+pickup+'</div>'+
          '</div>'+
          '<button class="btn primary reserve" data-offer-id="'+esc(offerId)+'" '+(sold?'disabled':'')+'>'+(sold?'Sold out':'Reserve')+'</button>'+
          '<div class="qtybadge '+(sold?'soldout':'')+'">'+(sold?'Sold out':('Qty '+qty))+'</div>';
        list.appendChild(card);

        // marker
        const lat = Number(o.Lat), lng = Number(o.Lng);
        if (!isNaN(lat) && !isNaN(lng)){
          const m = L.marker([lat,lng]).addTo(markers);
          m.bindPopup('<b>'+esc(o.ItemName||'')+'</b><br/>AED '+fmt(o.PriceAfter||0)+' â€¢ '+esc(o.PartnerName||o.OutletName||'')+
                      '<br><button class="btn primary reserve" data-offer-id="'+esc(offerId)+'" '+(sold?'disabled':'')+'>'+(sold?'Sold out':'Reserve')+'</button>');
          bounds.push([lat,lng]);
        }
      });

      if (bounds.length && map) map.fitBounds(bounds,{padding:[30,30]});

      // wire reserve buttons (cards + popups)
      document.querySelectorAll('.reserve').forEach(btn=>{
        btn.addEventListener('click', async ev => {
          const id = ev.currentTarget.getAttribute('data-offer-id') || '';
          if (!id) return alert('Offer unavailable');
          const name = prompt('Your name (for pickup):','') || '';
          if (!name.trim()) return alert('Please enter your name');
          const phone = prompt('Mobile (optional):','') || '';
          const payload = { offerId:id, customerName:name.trim(), customerPhone:phone.trim() };

          // ensure expiry just before reserving
          await fetch(API_URL + '?route=expire', { cache:'no-store' }).catch(()=>{});

          try{
            const res = await fetch(API_URL + '?route=reserve', {
              method:'POST',
              headers:{ 'Content-Type':'text/plain;charset=utf-8' },
              body: JSON.stringify(payload)
            });
            const out = await res.json();
            if (!out.ok){
              if (out.reason === 'sold_out') return alert('Sorry, this offer just sold out.');
              return alert('Could not reserve: ' + (out.reason || 'unknown'));
            }
            alert('Reserved! Pickup code: ' + out.PickupCode + '\n(Show this code at pickup.)');
            fetchMetrics(); // update stats
            fetchOffers();  // refresh cards/qty
          }catch(e){
            alert('Network error while reserving.');
          }
        });
      });
    }

    // init
    window.addEventListener('DOMContentLoaded', ()=>{
      const q = $('#q'); if (q) q.addEventListener('input', e => { filters.q = e.target.value; render(); });
      const useLoc = $('#useLocation');
      if (useLoc) useLoc.addEventListener('click', ()=>{
        if (!navigator.geolocation) return alert('Geolocation not supported');
        navigator.geolocation.getCurrentPosition(pos=>{
          const {latitude, longitude} = pos.coords; map.setView([latitude, longitude], 13);
        }, ()=>alert('Could not get your location'));
      });

      initMap();
      fetchMetrics();
      fetchOffers();
    });
  })();
  </script>
</body>
</html>
